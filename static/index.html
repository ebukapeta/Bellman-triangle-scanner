<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Crypto Arbitrage Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .scan-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .exchange-selector {
            flex: 2;
            min-width: 250px;
        }
        
        .exchange-selector h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 30px;
            transition: all 0.2s;
        }
        
        .checkbox-group label.binance {
            background: #f0b90b20;
            border: 2px solid #f0b90b;
        }
        
        .checkbox-group label.bybit {
            background: #5c6bc020;
            border: 2px solid #5c6bc0;
        }
        
        .checkbox-group label.kucoin {
            background: #0095e520;
            border: 2px solid #0095e5;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .param-item {
            flex: 1;
            min-width: 150px;
        }
        
        .param-item label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .param-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .scan-btn {
            padding: 12px 30px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 150px;
        }
        
        .scan-btn:hover { background: #2563eb; }
        .scan-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .status-bar {
            margin-top: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .log-section {
            margin-top: 20px;
        }
        
        .log-container {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
            color: #ccc;
        }
        
        .log-time { color: #888; min-width: 70px; }
        .log-exchange { 
            min-width: 80px; 
            text-transform: capitalize;
            font-weight: 600;
        }
        .log-exchange.binance { color: #f0b90b; }
        .log-exchange.bybit { color: #5c6bc0; }
        .log-exchange.kucoin { color: #0095e5; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }
        
        .summary-card.binance { border-left-color: #f0b90b; }
        .summary-card.bybit { border-left-color: #5c6bc0; }
        .summary-card.kucoin { border-left-color: #0095e5; }
        
        .summary-title {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .stat-label { font-size: 11px; color: #888; }
        .stat-value { font-size: 16px; font-weight: 700; color: #333; }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .results-table th {
            text-align: left;
            padding: 15px 10px;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }
        
        .results-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-table tr:hover {
            background: #f8fafc;
        }
        
        .exchange-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            color: white;
        }
        
        .exchange-badge.binance { background: #f0b90b; }
        .exchange-badge.bybit { background: #5c6bc0; }
        .exchange-badge.kucoin { background: #0095e5; }
        
        .profit-high { color: #10b981; font-weight: 700; }
        .profit-medium { color: #f59e0b; font-weight: 600; }
        .profit-low { color: #ef4444; }
        
        .chance-high { color: #10b981; font-weight: 600; }
        .chance-medium { color: #f59e0b; }
        .chance-low { color: #ef4444; }
        
        .view-btn {
            padding: 6px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .view-btn:hover { background: #2563eb; }
        
        @media (max-width: 768px) {
            .scan-controls { flex-direction: column; align-items: stretch; }
            .checkbox-group { justify-content: center; }
            .results-table { font-size: 12px; }
            .results-table td, .results-table th { padding: 10px 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™ô Crypto Arbitrage Scanner</h1>
            <p>Bellman-Ford Algorithm ‚Ä¢ Binance ‚Ä¢ Bybit ‚Ä¢ KuCoin</p>
        </div>
        
        <div class="card">
            <div class="scan-controls">
                <div class="exchange-selector">
                    <h3>Select Exchanges</h3>
                    <div class="checkbox-group">
                        <label class="binance">
                            <input type="checkbox" id="binance" checked> Binance
                        </label>
                        <label class="bybit">
                            <input type="checkbox" id="bybit" checked> Bybit
                        </label>
                        <label class="kucoin">
                            <input type="checkbox" id="kucoin" checked> KuCoin
                        </label>
                    </div>
                </div>
                
                <div class="param-item">
                    <label>Min Profit %</label>
                    <input type="number" id="minProfit" value="0.3" step="0.1" min="0.1">
                </div>
                
                <div class="param-item">
                    <label>Duration (sec)</label>
                    <input type="number" id="duration" value="10" step="1" min="5" max="30">
                </div>
                
                <button class="scan-btn" id="scanBtn">
                    <span id="btnText">üîç Scan Now</span>
                    <span id="btnLoader" style="display:none;"><span class="loading"></span> Scanning...</span>
                </button>
            </div>
            
            <div class="status-bar" id="status">
                <span>‚úÖ Ready to scan</span>
            </div>
        </div>
        
        <div class="card" id="logCard" style="display:none;">
            <h3>üìã Scan Activity</h3>
            <div class="log-section">
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
        
        <div class="card" id="summaryCard" style="display:none;">
            <h3>üìä Collection Summary</h3>
            <div class="summary-grid" id="summaryGrid"></div>
        </div>
        
        <div class="card" id="resultsCard" style="display:none;">
            <h3 id="resultsTitle">üéØ Arbitrage Opportunities</h3>
            <div style="overflow-x: auto;">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>Triangle</th>
                            <th>Profit (Before)</th>
                            <th>Profit (After)</th>
                            <th>Chance</th>
                            <th>Slippage</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let selectedExchanges = new Set(['binance', 'bybit', 'kucoin']);
    
    // Exchange checkbox handlers
    document.getElementById('binance').addEventListener('change', (e) => {
        if (e.target.checked) selectedExchanges.add('binance');
        else selectedExchanges.delete('binance');
    });
    
    document.getElementById('bybit').addEventListener('change', (e) => {
        if (e.target.checked) selectedExchanges.add('bybit');
        else selectedExchanges.delete('bybit');
    });
    
    document.getElementById('kucoin').addEventListener('change', (e) => {
        if (e.target.checked) selectedExchanges.add('kucoin');
        else selectedExchanges.delete('kucoin');
    });
    
    async function checkApiHealth() {
        try {
            const response = await fetch('/health');
            const text = await response.text();
            console.log('Health check:', text);
            return response.ok;
        } catch (error) {
            console.error('Health check failed:', error);
            return false;
        }
    }
    
    document.getElementById('scanBtn').addEventListener('click', async () => {
        if (selectedExchanges.size === 0) {
            alert('Please select at least one exchange');
            return;
        }
        
        // First check if API is reachable
        const isHealthy = await checkApiHealth();
        if (!isHealthy) {
            document.getElementById('status').innerHTML = '‚ùå API server not responding properly';
            return;
        }
        
        const minProfit = parseFloat(document.getElementById('minProfit').value);
        const duration = parseInt(document.getElementById('duration').value);
        
        // Update UI
        document.getElementById('btnText').style.display = 'none';
        document.getElementById('btnLoader').style.display = 'inline';
        document.getElementById('scanBtn').disabled = true;
        document.getElementById('status').innerHTML = `<span class="loading"></span> Collecting data for ${duration} seconds...`;
        
        // Clear previous results
        document.getElementById('logContainer').innerHTML = '';
        document.getElementById('summaryGrid').innerHTML = '';
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('logCard').style.display = 'block';
        document.getElementById('summaryCard').style.display = 'none';
        document.getElementById('resultsCard').style.display = 'none';
        
        try {
            const requestBody = {
                exchanges: Array.from(selectedExchanges),
                min_profit: minProfit,
                collection_duration: duration
            };
            
            console.log('Sending request:', requestBody);
            
            const response = await fetch('/api/scan', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if response is OK
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`Server returned ${response.status}: ${errorText.substring(0, 100)}`);
            }
            
            // Check content type
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text.substring(0, 200));
                throw new Error('Server returned non-JSON response. Expected JSON but got: ' + contentType);
            }
            
            const data = await response.json();
            console.log('Received data:', data);
            
            // Display logs
            const logContainer = document.getElementById('logContainer');
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `
                        <span class="log-time">${log.timestamp || '??'}</span>
                        <span class="log-exchange ${log.exchange || ''}">${log.exchange || 'unknown'}</span>
                        <span class="log-${log.level || 'info'}">${log.message || ''}</span>
                    `;
                    logContainer.appendChild(logEntry);
                });
                logContainer.scrollTop = logContainer.scrollHeight;
            } else {
                logContainer.innerHTML = '<div class="log-entry">No logs available</div>';
            }
            
            // Display summaries
            if (data.summaries && data.summaries.length > 0) {
                document.getElementById('summaryCard').style.display = 'block';
                const summaryGrid = document.getElementById('summaryGrid');
                data.summaries.forEach(summary => {
                    const card = document.createElement('div');
                    card.className = `summary-card ${summary.exchange || ''}`;
                    card.innerHTML = `
                        <div class="summary-title">${(summary.exchange || 'unknown').toUpperCase()}</div>
                        <div class="summary-stats">
                            <div><span class="stat-label">Pairs:</span> <span class="stat-value">${summary.pairs_collected || 0}</span></div>
                            <div><span class="stat-label">Paths:</span> <span class="stat-value">${summary.paths_found || 0}</span></div>
                            <div><span class="stat-label">Profitable:</span> <span class="stat-value">${summary.profitable_triangles || 0}</span></div>
                            <div><span class="stat-label">Time:</span> <span class="stat-value">${summary.collection_time_secs || 0}s</span></div>
                        </div>
                    `;
                    summaryGrid.appendChild(card);
                });
            }
            
            // Display opportunities in table
            if (data.opportunities && data.opportunities.length > 0) {
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('resultsTitle').innerHTML = `üéØ Arbitrage Opportunities (${data.opportunities.length})`;
                
                const tableBody = document.getElementById('tableBody');
                data.opportunities.forEach(opp => {
                    const profitClass = opp.profit_margin_before > 1.0 ? 'profit-high' : 
                                      (opp.profit_margin_before > 0.5 ? 'profit-medium' : 'profit-low');
                    
                    const chanceClass = opp.chance_of_executing > 80.0 ? 'chance-high' :
                                      (opp.chance_of_executing > 70.0 ? 'chance-medium' : 'chance-low');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="exchange-badge ${opp.exchange || ''}">${(opp.exchange || 'unknown').toUpperCase()}</span></td>
                        <td style="font-family: monospace;">${opp.pair || 'N/A'}</td>
                        <td class="${profitClass}">${(opp.profit_margin_before || 0).toFixed(3)}%</td>
                        <td>${(opp.profit_margin_after || 0).toFixed(3)}%</td>
                        <td class="${chanceClass}">${(opp.chance_of_executing || 0).toFixed(1)}%</td>
                        <td>${(opp.estimated_slippage || 0).toFixed(3)}%</td>
                        <td><button class="view-btn" onclick='alert("Triangle Path:\\n${(opp.triangle || []).join(' ‚Üí ')}")'>View</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('status').innerHTML = `‚úÖ Found ${data.opportunities.length} opportunities`;
            } else {
                document.getElementById('status').innerHTML = '‚ùå No arbitrage opportunities found';
            }
            
        } catch (error) {
            console.error('Full error:', error);
            document.getElementById('status').innerHTML = `‚ùå Error: ${error.message}`;
            
            // Add error to log
            const logContainer = document.getElementById('logContainer');
            const errorEntry = document.createElement('div');
            errorEntry.className = 'log-entry';
            errorEntry.innerHTML = `
                <span class="log-time">${new Date().toLocaleTimeString()}</span>
                <span class="log-exchange">system</span>
                <span class="log-error">${error.message}</span>
            `;
            logContainer.appendChild(errorEntry);
        } finally {
            // Reset button
            document.getElementById('btnText').style.display = 'inline';
            document.getElementById('btnLoader').style.display = 'none';
            document.getElementById('scanBtn').disabled = false;
        }
    });

    // Auto-run health check on page load
    window.addEventListener('load', async () => {
        const healthy = await checkApiHealth();
        if (healthy) {
            document.getElementById('status').innerHTML = '‚úÖ API connected. Ready to scan.';
        } else {
            document.getElementById('status').innerHTML = '‚ùå API not reachable. Check server.';
        }
    });
  </script>
</body>
</html>
